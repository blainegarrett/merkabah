{% load tt_merkabah %}
<!DOCTYPE html>
<html>
<head>
  	<title>Control Center</title>

	<!-- Always force latest IE rendering engine or request Chrome Frame -->
  	<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" />
	<meta name="viewport" content="width=device-width, maximum-scale=1, initial-scale=1, user-scalable=0" />

	<script src="/merkabah/static/js/jquery.min.js"></script>
	<script src="/merkabah/static/js/jquery.form.js"></script>
	

	<script src="/merkabah/static/plugins/ckeditor/ckeditor.js"></script>
	<script src="/merkabah/static/plugins/ckeditor/adapters/jquery.js"></script>

	<script src="/merkabah/static/admin/themes/plastique/javascripts/application.js" type="text/javascript"></script>
	<script src="/merkabah/static/admin/themes/plastique/javascripts/docs.js" type="text/javascript"></script>
	<script src="/merkabah/static/admin/themes/plastique/javascripts/docs_charts.js" type="text/javascript"></script>
	<script src="/merkabah/static/admin/themes/plastique/javascripts/documentation.js" type="text/javascript"></script>
	<script src="/merkabah/static/admin/themes/plastique/javascripts/prettify.js" type="text/javascript"></script>


	<link href="/merkabah/static/admin/themes/plastique/stylesheets/application.css" media="screen" rel="stylesheet" type="text/css" />
	<link href="/merkabah/static/admin/themes/plastique/stylesheets/prettify.css" media="screen" rel="stylesheet" type="text/css" />

<style>
	body .modal_wide {
		width: 80%;
		margin-left: -40%;
	}
</style>

<script type="text/javascript">
	//prettyPrint()
</script>

<script>
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
var csrftoken = getCookie('csrftoken');

</script>


<script>

var merkabah = {};
merkabah.utils = {};


merkabah.render_form_dialog = function(url, form_id, form_content, dialog_title) {
	
	var dialog = $('<div id="modal_for_form_' + form_id + '" class="modal hide fade modal_wide" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">');
	var form = $('<form class="fill-up" id="' + form_id + '" method="POST" action="' + url + '">');
	dialog.append(form);

	var header = $('<div class="modal-header">');

	var close = $('<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>');
	header.append(close);

	var modal_title = $('<h3 id="myModalLabel">' + dialog_title + '</h3>');
	header.append(modal_title);

	form.append(header);

	var modal_body = $('<div class="modal-body"> '  + form_content + ' </div>');

	// TODO: Pass these via the ajax data args
	//modal_body.append($('<input type="hidden" name="action" value="display_form"/>'));
	//modal_body.append($('<input type="hidden" name="form_id" value="' + form_id + '"/>'));

	form.append(modal_body);

	var modal_footer = $('<div class="modal-footer">');

	modal_footer.append($('<button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>'));
	modal_footer.append($('<button class="btn btn-primary">Submit</button>'));

	form.append(modal_footer);

	//var dialog = $('<div class="modal-body"> '  + form_content + ' </div> <div class="modal-footer"> <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button> <button class="btn btn-primary">Submit</button> </div>  </form> </div>');
	$('body').append(dialog);
	
	$('.ckeditor', dialog).ckeditor()
	return dialog.modal();
}


merkabah.utils.parse_query_params = function(query_string){
	/* Thank you Andy E - http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values */
	var urlParams = {};
    var match,
        pl     = /\+/g,  // Regex for replacing addition symbol with a space
        search = /([^&=]+)=?([^&]*)/g,
        decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
        query  = window.location.search.substring(1);

    while (match = search.exec(query_string))
       urlParams[decode(match[1])] = decode(match[2]);

	return urlParams;
};

/* Handlers */
$.fn.redirect_handler = function(data){
	/*
	Handler to redirect
	*/

	window.location = data.url;
}

$.fn.alert_handler = function(data){
	/*
	Handler to redirect
	*/

	alert(data.message);
}

$.fn.error_handler = function(data){
	/*
	Handler to redirect
	*/

	data.title = 'An error occurred.'
	$.fn['dialog_handler'].apply(this, [data]);
}

$.fn.dialog_handler = function(data){
	/*
	Handler to redirect
	*/

	//$('body').append('what?');
	var dialog = $('#myModal');
	$('.modal-body', dialog).html('').append(data.content);
	$('#myModalLabel', dialog).html('').append(data.title);
	$(dialog).modal('toggle');
}

$.fn.close_form_dialog_handler = function(data) {
	/*
	Close The Dialog
	*/

	console.log(data);

	var form_id = data.form_id;
	var dialog = $('#modal_for_form_' + form_id + '');

	$(dialog).modal('hide');
	
}

$.fn.form_handler = function(data){
	/* Handler for form responses */
	var form_id, dialog_title, rendered_form;

	form_id = data.form_id

	if (!form_id) {
		alert('Please provide a form_id');
	}

	dialog_title = data.title
	rendered_form = data.form
	url = data.target_url
	action = data.target_action

	//$.fn['dialog_handler'].apply(this, [data]);

	window.dialog = merkabah.render_form_dialog(url, form_id, rendered_form, dialog_title)
	dialog.show('show');

	var submit_data = {'form_id': form_id, 'action' : action};
	var ajax_settings = merkabah.get_ajax_form_settings(submit_data, 'get');
	
	$('#' + form_id).ajaxForm(ajax_settings);
}

$.fn.dynamic_content_handler = function(data) {
	var node_id = data.node_id

	if (!node_id) {
		alert('Node id ' + node_id + ' given, but doesn\'t exist in dom.')
	}

	var target_node = $('#' + node_id);
	if (!target_node.size()) {
		console.log('Received a dynamic content response type with target id of "' + node_id + '" but failed to find the node in the existing dom.');
	}
	
	target_node.html(data.content);
	merkabah.apply_bindings(target_node);

}

merkabah.get_ajax_form_settings = function(data, type) {
	if (type){
		type = 'post';
	}

	var csrftoken = getCookie('csrftoken');
	console.log(csrftoken);

	var ajax_settings = {
		'dataType' : 'json',
		'data' : data,
		'async': false,
		'type' : type,
		'csrfmiddlewaretoken' : csrftoken,
		crossDomain: false, // obviates need for sameOrigin test
		beforeSend: function(xhr, settings) {
		        //if (!csrfSafeMethod(settings.type)) {
		            xhr.setRequestHeader("X-CSRFToken", csrftoken);
		        //}
		},

		success: merkabah.ajax_success,
		error: function(data, textStatus, errorThrown) {
			data.title = 'There was an error with this ajax call. See log for details.'
			data.content = data.responseText
			return $.fn.error_handler.apply(this, [data]);
		}			
	};
	return ajax_settings;
}

$.fn.form_error_handler = function(data){

	var form_id = data.form_id;
	var xform = $('#' + form_id);
	if (xform.size() === 0){
		alert('Form with id "' + form_id + '" not found on page.');
	}

	// Clear existing errors on the form
	$('.error .help-inline', xform).html('');
	$('.error', xform).removeClass('error');
	$('.alert', xform).remove();		


	/*
	<div class="input">
		<input type="text" placeholder="Username" class="error">
	    <span class="input-error" data-title="please write a valid username" data-original-title="">
	    	<i class="icon-warning-sign"></i>
		</span>
	</div>
	*/


	//field_control_group.addClass('error');

	var error_list = jQuery.parseJSON(data['form_errors']);

	$.each(error_list, function(field_name, field_errors){
		var field_control_group, field_help_inline;
		
		var input = $('#id_' + field_name)
		input.addClass('error');

		field_control_group = input.parents('.input');
		field_control_group.append('<span class="input-error" data-title="please write a valid username" data-original-title=""><i class="icon-warning-sign"></i></span>');

	});

	alert_notice = $('<div class="alert alert-error"><button type="button" class="close" data-dismiss="alert">&times;</button> <strong>Warning!</strong> There was an error with your form. </div>');

	form_in_dialog = $('#modal_for_form_' + form_id).size() > 0;
	if (form_in_dialog) {
		$('#modal_for_form_' + form_id + ' .modal-body').prepend(alert_notice);
	}
	else {
		xform.prepend(alert_notice);
	}
}
merkabah.run_action = {};
merkabah.run_action.error_message = 'We are experiencing technical difficulties. Please try again momentarily.';


merkabah.ajax_success = function(data, textStatus, jqXHR){
	/*
	Default Merkabah Response List handler
	*/
	
	
	//var action_responses = data.action_responses;

	var action_responses = data.action_response_list;

	//action_responses = action_responses
	
	$.each(action_responses, function(i, action_response) {
		var action_response = jQuery.parseJSON(action_response);
		var response_handler_name = action_response.response_type; // data.response_type;

		if (response_handler_name) {
			response_handler_name = response_handler_name + '_handler';
			
			response_handler = $.fn[response_handler_name];

			if (!(response_handler)) {
				data.title = 'Response Handler Error'
				data.content = 'No response handler <b>' + response_handler_name + '</b> defined in $.fn.'
				return $.fn.error_handler.apply(this, [action_response]);
			}
			else {
				return response_handler.apply(this, [action_response]);
			}
		
		}
		else {
			alert('Action executed, but return did not contain a response_type param. See log.');
		}
	}); // each
}



merkabah.run_action.execute = function(pathname, data) {
	/* */
	response_method = 'get'

	url = pathname
	settings = {
		'dataType' : 'json',
		'data' : data,
		'type' : response_method,
		'csrfmiddlewaretoken' : csrftoken,
		crossDomain: false, // obviates need for sameOrigin test
		beforeSend: function(xhr, settings) {
		        //if (!csrfSafeMethod(settings.type)) {
		            xhr.setRequestHeader("X-CSRFToken", csrftoken);
		        //}
		},
		success: merkabah.ajax_success,
		error: function(data, textStatus, errorThrown) {
			data.title = 'There was an error with this ajax call. See log for details.'
			data.content = data.responseText
			return $.fn.error_handler.apply(this, [data]);
		}			
	};

	$.ajax(url, settings);
}
merkabah.apply_bindings = function(node){

	/* Bind action buttons, links, etc */
	$('.action', node).click(function(e){
		e.preventDefault();
		var btn = this;
		var $btn = $(this);

		var pathname = btn.pathname
		var query_string = btn.search;

		if (query_string.length >= 1 && query_string[0] == '?')
			query_string = query_string.substring(1);

		q_params = merkabah.utils.parse_query_params(query_string);		
		merkabah.run_action.execute(pathname, q_params);

		return false
	});
	
};


$(function(){
	merkabah.apply_bindings($(document));

});

</script>


</head>
<body>



<div id="modal" class="black-box modal hide fade">
  <div class="modal-header tab-header">
    <button type="button" class="close" data-dismiss="modal">&times;</button>
    <span>Some modal title</span>
  </div>
  <div class="modal-body separator">
    <h4>Text in a modal</h4>
    <p>Duis mollis, est non commodo luctus, nisi erat porttitor ligula, eget lacinia odio sem.</p>
  </div>
  <div class="modal-footer">
    <div class="inner-well">
      <a class="button mini rounded light-gray" data-dismiss="modal">Close</a>
      <a class="button mini rounded blue">Save changes</a>
    </div>
  </div>
</div>

<div id="modal-gallery" class="black-box modal modal-gallery hide fade">
  <div class="modal-header tab-header">
    <button type="button" class="close" data-dismiss="modal">&times;</button>
    <span class="modal-title"></span>
  </div>
  <div class="modal-body"><div class="modal-image"></div></div>
  <div class="modal-footer">
    <div class="pull-left">
      You can also change the images<br/> by scrolling the mouse wheel!
    </div>
    <div class="pull-right">
      <a class="button blue modal-next">Next <i class="icon-arrow-right icon-white"></i></a>
      <a class="button gray modal-prev"><i class="icon-arrow-left icon-white"></i> Previous</a>
      <a class="button green modal-play modal-slideshow" data-slideshow="5000"><i class="icon-play icon-white"></i> Slideshow</a>
      <a class="button black" target="_blank"><i class="icon-download"></i> Download</a>
    </div>
  </div>
</div>


	<nav id="primary" class="main-nav">{% include 'merkabah/admin/ui/primary_menu.html' %}</nav>


<nav id="secondary" class="main-nav">

  <div class="profile-menu">

    <div class="pull-left">
      <div class="avatar">
        <img src="/merkabah/static/admin/themes/plastique/images/avatar.png" />
      </div>
    </div>

    <div class="pull-left">
      <div class="title">
        Hi, <span title="{{ user.nickname }}">{{ user.nickname|truncate:10 }}</span>
      </div>
      <div class="btn-group">
        <button class="button mini inset black"><i class="icon-search"></i></button>
        <button class="button mini inset black">Projects</button>
        <button class="button mini inset black dropdown-toggle" data-toggle="dropdown"><i class="icon-cog"></i></button>
        <ul class="dropdown-menu black-box-dropdown">
          <li><a href="#">Action</a></li>
          <li><a href="#">Another action</a></li>
          <li><a href="#">Something else here</a></li>
          <li class="divider"></li>
          <li><a href="#">Separated link</a></li>
        </ul>

      </div>
    </div>

    <div class="pull-right profile-menu-nav-collapse">
      <button class="button black"><i class="icon-reorder"></i></button>
    </div>

  </div>


<ul class="secondary-nav-menu">
	<li class="">
	  <a href="/madmin/blog/post/">
	      <i class="icon-file"></i> Posts
	  </a>
	</li>
	<li class="">
  		<a href="/madmin/blog/category/">
      		<i class="icon-tasks"></i> Categories
  		</a>
	</li>
  </ul>


</nav>



<section id="main">
  <div class="top-nav">
  <div class="container-fluid">
    <div class="row-fluid search-button-bar-container">
      <div class="span12">
        <ul class="breadcrumb">
          <li><a href="#"><i class="icon-home"></i> Some</a></li>
          <li><a href="#">Nice</a></li>
          <li><a href="#">Breadcrumbs</a></li>
          <li class="active"><a href="#">Here</a></li>
        </ul>
        <a class="search-button-trigger" href="#"><i class="icon-search"></i></a>
      </div>
    </div>

    <div class="row-fluid search-bar-nav">
      <div class="span12">
        <form>
          <input type="text" class="search" placeholder="Search...">
        </form>
      </div>
    </div>
  </div>
</div>

  <div class="container-fluid">
    <div class="row-fluid">
  		<div class="span12">
 			<!-- main content -->
			<div style="overflow:auto;" ng-view>

				{{ body_content|safe}}
			</div>
			
			<!-- main content -->
		</div>
	</div>
    <div class="row-fluid">
  <div class="span12">
    <div class="footer">
	....sf.f.sdsd.
      <div>2013 &copy; Plastique Admin Theme</div>
      <div>Carefully crafted by <a href="https://wrapbootstrap.com/user/andrei4002">andrei4002</a></div>
    </div>
  </div>
</div>
  </div>
</section>

<script type="text/html" id="template-notification">
  <div class="notification animated fadeInLeftMiddle fast{{ item.itemClass }}">
    <div class="left">
      <div style="background-image: url({{ item.imagePath }})" class="{{ item.imageClass }}"></div>
    </div>
    <div class="right">
      <div class="inner">{{ item.text }}</div>
      <div class="time">{{ item.time }}</div>
    </div>

    <i class="icon-remove-sign hide"></i>
  </div>
</script>
<script type="text/html" id="template-notifications">
  <div class="container">
    <div class="row" id="notifications-wrapper">
      <div id="notifications" class="{{ bootstrapPositionClass }} notifications animated">
        <div id="dismiss-all" class="dismiss-all button blue">Dismiss all</div>
        <div id="content">
          <div id="notes"></div>
        </div>
      </div>
    </div>
  </div>
</script>

<!-- model used for general things -->
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-header">
    	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    	<h3 id="myModalLabel"></h3>
  	</div>
  	<div class="modal-body">
    	<p></p>
  	</div>
  	<div class="modal-footer">
    	<button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
    	<!-- <button class="btn btn-primary">Save changes</button> -->
  	</div>
</div>
<!-- end modal-- >



<!-- model used for primary forms things -->
<div id="primary_form_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="primary_form_modal_label" aria-hidden="true">
	<form id="" class="fill-up" action="">
		<div class="modal-header">
	    	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
	    	<h3 id="primary_form_modal_label"></h3>
	  	</div>
	  	<div class="modal-body">
	    	<p></p>
	  	</div>
	  	<div class="modal-footer">
	    	<button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
	    	<button class="btn btn-primary">Save changes</button>
	  	</div>

	</form>
</div>
<!-- end modal-- >




</body>
</html>
